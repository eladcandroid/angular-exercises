# תרגיל: טעינה נדחית (Deferrable Views) ב-Angular - @defer

## תיאור כללי

תרגיל זה נועד לבחון את הידע שלך בנושא Deferrable Views (@defer) ב-Angular - טכניקה מתקדמת לאופטימיזציה של ביצועים. זהו תרגיל ברמת ביניים-מתקדמת שמכסה את כל היכולות של @defer בלוקים.

**תרחיש:** אתם בונים קטלוג מוצרים לחנות מקוונת. חלק מהקומפוננטות כבדות ויש להעלות אותן רק כשהמשתמש צריך אותן, כדי לשפר את ביצועי הטעינה הראשונית.

**משך זמן משוער:** 2-3 שעות
**רמת קושי:** ביניים-מתקדמת

## מטרות הלמידה

בסיום התרגיל תוכיח/י שאת/ה יודע/ת:

- ✅ להשתמש ב-@defer בלוקים לטעינה נדחית של קומפוננטות
- ✅ לעבוד עם @placeholder, @loading ו-@error בלוקים
- ✅ להשתמש בטריגרים שונים: viewport, interaction, hover, timer, idle
- ✅ ליצור תנאים מותאמים אישית עם when
- ✅ להטמיע אסטרטגיות prefetching
- ✅ להבין את ההבדל בין טעינת קוד להצגת תוכן
- ✅ לשלב @defer עם @if לשליטה מלאה
- ✅ לאפטם את ביצועי האפליקציה

## מה זה @defer?

**@defer** היא תחביר תבנית מודרני ב-Angular המאפשר לטעון חלקים מהתבנית רק כשהם נדרשים. במקום לטעון את כל הקוד בבת אחת, Angular יוצר bundle נפרד עבור התוכן הנדחה וטוען אותו רק כשמתקיים תנאי מסוים.

**יתרונות:**
- 🚀 הפחתת גודל ה-bundle הראשוני
- ⚡ שיפור זמן הטעינה הראשונית (TTI - Time to Interactive)
- 📦 טעינה גרנולרית יותר מ-lazy loading ברמת הראוטר
- 🎯 שליטה מדויקת מתי לטעון קוד

## דרישות התרגיל

### חלק א': מבנה הפרויקט

צור/י את הקומפוננטות הבאות (כולן **standalone**):

#### 1. ProductListComponent (קומפוננטת האב)
זוהי הקומפוננטה הראשית שמציגה רשימת מוצרים.

**דרישות:**
- רשימה של 10 מוצרים (מערך סטטי)
- כל מוצר מכיל: שם, תמונה, מחיר, תיאור קצר
- תצוגה בסיסית של כרטיסי מוצרים

#### 2. ProductDetailsComponent (טעינה נדחית - viewport)
קומפוננטה כבדה שמציגה פרטי מוצר מורחבים.

**דרישות טעינה נדחית:**
- הקומפוננטה תיטען כשהיא נכנסת לאזור הנראה של המסך (viewport)
- הצג תוכן זמני (placeholder) שיהיה גלוי לפחות חצי שנייה כדי למנוע הבהוב במסך
- הצג אינדיקטור טעינה רק אם הטעינה אורכת יותר ממאית השנייה, והשאר אותו גלוי לפחות שנייה אחת
- טפל במצב של שגיאה בטעינה והצג הודעה מתאימה
- התוכן הזמני יציג הודעה שמעודדת את המשתמש לגלול למטה

**תוכן הקומפוננטה:**
- תיאור מלא של המוצר
- גלריית תמונות (3-5 תמונות)
- מפרט טכני
- מחיר מפורט

#### 3. ProductReviewsComponent (טעינה נדחית - interaction)
קומפוננטה שמציגה ביקורות לקוחות.

**דרישות טעינה נדחית:**
- הקומפוננטה תוצג רק כשהמשתמש מבצע אינטראקציה (לחיצה או הקשה)
- הורד את קוד הקומפוננטה מראש כשהדפדפן במצב סרק (idle)
- התוכן הזמני יהיה כפתור שמזמין את המשתמש לצפות בביקורות
- אינדיקטור הטעינה יהיה גלוי למשך 4/5 שנייה לפחות
- הכפתור יכול להציג את מספר הביקורות הזמינות

**תוכן הקומפוננטה:**
- רשימת 5-10 ביקורות
- כל ביקורת מכילה: שם, דירוג (כוכבים), תאריך, תוכן
- ממוצע דירוג
- טופס הוספת ביקורת חדשה

#### 4. RelatedProductsComponent (טעינה נדחית - hover)
קומפוננטה שמציגה מוצרים קשורים.

**דרישות טעינה נדחית:**
- הקומפוננטה תוצג כשהמשתמש מעביר את העכבר מעל האזור
- הורד את הקוד מראש כשהאזור נכנס לחלק הנראה של המסך
- התוכן הזמני יציג הודעה שמעודדת את המשתמש להעביר עכבר
- אינדיקטור הטעינה יופיע רק אחרי חמישית שנייה, ויהיה גלוי לפחות 3/5 שנייה
- הקומפוננטה תקבל את קטגוריית המוצר כקלט

**תוכן הקומפוננטה:**
- 4-6 מוצרים קשורים
- תצוגת כרטיסים קטנים
- קישור לכל מוצר

#### 5. ProductAnalyticsComponent (טעינה נדחית - custom trigger)
קומפוננטה כבדה עם גרפים וסטטיסטיקות.

**דרישות טעינה נדחית:**
- הקומפוננטה תיטען בהתאם לתנאי מותאם אישית שתגדיר
- צור משתנה בוליאני שקובע אם להציג את הניתוחים (התחל עם ערך שלילי)
- צור משתנה נוסף שמסמל אם המשתמש הוא מנהל (התחל עם ערך חיובי)
- הורד את הקוד מראש רק אם המשתמש הוא מנהל
- התוכן הזמני יהיה כפתור שמציג "הצג נתונים סטטיסטיים"
- צור פונקציה שמחליפה את מצב התצוגה של הניתוחים
- אינדיקטור הטעינה יופיע רק אחרי חצי שנייה, ויהיה גלוי לפחות שנייה שלמה
- הכפתור יפעיל את הפונקציה בלחיצה

**תוכן הקומפוננטה:**
- מספר צפיות במוצר
- מספר רכישות
- גרף פשוט (CSS-based)
- נתוני מלאי

#### 6. PromotionalBannerComponent (טעינה נדחית - timer)
באנר פרסומי שמופיע אחרי זמן מוגדר.

**דרישות טעינה נדחית:**
- הבאנר יופיע אוטומטית אחרי 3 שניות מטעינת הדף
- אין צורך בתוכן זמני - הבאנר פשוט יופיע אחרי הזמן הקבוע
- אינדיקטור הטעינה יהיה גלוי לפחות חצי שנייה
- אין צורך בטיפול בשגיאות במקרה זה

**תוכן הקומפוננטה:**
- הודעת מבצע
- קוד קופון
- כפתור סגירה

### חלק ב': דרישות טכניות

1. **Standalone Components:**
   - כל הקומפוננטות חייבות להיות standalone
   - ללא NgModules

2. **טעינה נדחית:**
   - השתמש בכל סוגי הטריגרים: כניסה לאזור נראה, אינטראקציה, ריחוף עכבר, טיימר, ותנאי מותאם אישית
   - כל תוכן זמני צריך להיות גלוי למשך מינימלי כדי למנוע הבהוב במסך
   - אינדיקטורי טעינה צריכים להופיע רק אחרי השהייה מסוימת, ולהישאר גלויים למשך מינימלי
   - טפל בשגיאות טעינה עם הודעות מתאימות
   - הורד קוד מראש באסטרטגיות שונות לשיפור חווית המשתמש

3. **אופטימיזציה:**
   - תוכן זמני צריך להיות קל (ללא קומפוננטות כבדות)
   - השתמש בזמני המתנה מינימליים למניעת הבהוב ממושך
   - הורד קוד מראש באופן חכם - למנהלים או כשהמשתמש קרוב לאלמנט

4. **שילוב תנאים:**
   - שלב תנאים מותאמים בתוך בלוקים של טעינה נדחית
   - לדוגמה: בדוק אם מוצר במלאי לפני הצגת הפרטים
   - הצג תוכן שונה בהתאם למצב המוצר

5. **Styling:**
   - עיצוב מקצועי עם CSS
   - אנימציות למצבי טעינה
   - אינדיקטורים ויזואליים למצבי @loading
   - placeholders אטרקטיביים

## קריטריונים לבדיקה

התרגיל שלך יבדק לפי הקריטריונים הבאים:

### שימוש ב-@defer (30%)
- ✓ כל הקומפוננטות משתמשות ב-@defer נכון
- ✓ טריגרים שונים מוטמעים: viewport, interaction, hover, timer, when
- ✓ @defer blocks יוצרים bundles נפרדים (בדוק ב-build output)

### @placeholder, @loading, @error (25%)
- ✓ כל @defer block כולל @placeholder מתאים
- ✓ @loading blocks עם timing נכון (after, minimum)
- ✓ @error handling מוטמע
- ✓ @placeholder blocks קלים ולא מכילים קומפוננטות כבדות

### Prefetching Strategies (20%)
- ✓ שימוש ב-prefetch עם טריגרים שונים
- ✓ אסטרטגיה נכונה: prefetch on viewport + display on interaction
- ✓ prefetch when עם תנאי מותאם (userIsAdmin)

### Custom Triggers (15%)
- ✓ שימוש ב-when עם משתנה boolean
- ✓ פונקציה שמשנה את המשתנה
- ✓ prefetch when עובד נכון

### שילוב עם @if (10%)
- ✓ שימוש ב-@if בתוך @defer blocks
- ✓ לוגיקה נכונה של תצוגה מותנית

## משימות בונוס (אופציונלי)

רוצה אתגר נוסף? נסה/י ליישם:

### בונוס 1: Template Reference Variables
במקום להפעיל טעינה נדחית על האלמנט שמכיל את הבלוק, נסה להפעיל אותה כשאלמנט אחר במסך נכנס לאזור הנראה.

**רעיון:**
- צור אלמנט (למשל כותרת או חלק מהממשק) ושייך לו משתנה תבנית מקומי
- השתמש במשתנה זה כדי להגדיר מתי הקומפוננטה תיטען
- לדוגמה: הקומפוננטה של ביקורות תיטען כשהכותרת "ביקורות לקוחות" נכנסת לאזור הנראה

### בונוס 2: Multiple Triggers
הצג קומפוננטה כשאחד ממספר אירועים מתרחשים - או העברת עכבר או לחיצה.

**רעיון:**
- הגדר שתי דרכים שונות להפעלת אותה קומפוננטה
- המשתמש יוכל לגשת לתוכן בשתי דרכים
- חפש איך לשלב מספר טריגרים בבלוק אחד

### בונוס 3: Nested @defer
צור מבנה היררכי של טעינות נדחיות - קומפוננטה שנטענת בהדרגה עם רמות שונות של מידע.

**רעיון:**
- הקומפוננטה הראשית נטענת כשנכנסת לאזור הנראה
- בתוך הקומפוננטה הזו, יש חלק נוסף שנטען רק אחרי לחיצה על כפתור
- לדוגמה: פרטי מוצר נטענים ברגע שרואים אותם, אבל המפרט המלא נטען רק אחרי לחיצה על "הצג מפרט מלא"
- הכפתור יופיע כתוכן זמני של הבלוק הפנימי

### בונוס 4: Performance Monitoring
מדוד כמה זמן לוקח לקומפוננטה להיטען והצג את המידע הזה למשתמש.

**רעיון:**
- צור פונקציה שמחשבה כמה זמן עבר מאז שהטעינה התחילה
- הצג את הזמן הזה באינדיקטור הטעינה
- אפשר להשתמש באירועים שהקומפוננטה משדרת כשהיא מסיימת להיטען
- צריך לעקוב אחרי הזמן החל מהרגע שהטעינה מתחילה ועד שהקומפוננטה מוכנה

### בונוס 5: Conditional Prefetching
הורד קוד מראש רק אם המשתמש מחובר לאינטרנט מהיר, כדי לחסוך בנתונים למשתמשים עם חיבור איטי.

**רעיון:**
- בדוק את סוג החיבור של המשתמש דרך הדפדפן
- צור משתנה שמציין אם החיבור מהיר
- הורד קוד מראש רק כשהמשתנה הזה חיובי
- החיבור נחשב מהיר אם הוא מסוג 4g
- צריך לגשת לאובייקט המידע על החיבור של הדפדפן

### בונוס 6: Build Analysis
בדוק והדגם שהקוד שלך אכן יוצר bundles נפרדים לכל קומפוננטה נדחית.

**רעיון:**
- הרץ את פקודת הבנייה של Angular
- התבונן בפלט - אמורים להיות קבצי JavaScript נפרדים לכל קומפוננטה עם טעינה נדחית
- צלם screenshot של הפלט בקונסול
- כל bundle יקבל שם עם hash ייחודי
- זו הדרך לוודא שהאופטימיזציה באמת עובדת

## הגשה

1. **הרצת הפרויקט:**
   ```bash
   ng serve
   ```
   האפליקציה צריכה לרוץ בכתובת: `http://localhost:4200/`

2. **בדיקה עצמית:**
   - ✅ פתח DevTools → Network tab
   - ✅ רענן את הדף
   - ✅ ודא/י ש-@defer components לא נטענים מיד
   - ✅ גלול/לחץ/העבר עכבר כדי לטרגר טעינה
   - ✅ בדוק/י שה-bundles נטענים רק כשצריך
   - ✅ ודא/י ש-@loading ו-@placeholder מופיעים
   - ✅ בדוק/י שלא יש "flickering" (בזכות minimum times)

3. **Build Analysis:**
   ```bash
   ng build
   ```
   בדוק/י את הפלט - אמור להיות מספר bundles:
   ```
   main.js
   [product-details-component-hash].js
   [product-reviews-component-hash].js
   [related-products-component-hash].js
   ...
   ```

4. **איכות קוד:**
   - ✅ קוד נקי וקריא
   - ✅ שמות משתנים משמעותיים
   - ✅ הערות בקוד במידת הצורך
   - ✅ עקביות בשימוש ב-@defer patterns


## משאבים

### תיעוד Angular
- 📘 [Angular Defer Documentation](https://angular.dev/guide/defer)
- 📘 [Angular Performance Guide](https://angular.dev/guide/performance)
- 📘 [Lazy Loading Modules](https://angular.dev/guide/lazy-loading-ngmodules)

### מאמרים מומלצים
- 📄 [Angular University - @defer Guide](https://blog.angular-university.io/angular-defer/)
- 📄 [Angular Blog - Introducing @defer](https://blog.angular.io/introducing-angular-v17-4d7033312e4b)

### טיפים שימושיים
- 💡 השתמש/י ב-Chrome DevTools → Network → Throttling לבדוק טעינה איטית
- 💡 השתמש/י ב-Angular DevTools לצפייה במצב הקומפוננטות
- 💡 הרץ `ng build --stats-json` ואז `webpack-bundle-analyzer` לניתוח bundles
- 💡 בדוק/י את גודל ה-bundles לפני ואחרי שימוש ב-@defer

---

## הערות חשובות

⚠️ **שימו לב:**
- @defer עובד רק עם **standalone components**
- @placeholder צריך להיות קל - אל תשתמש/י בו בקומפוננטות כבדות
- שימוש ב-`minimum` חשוב למניעת UI flickering
- @defer לא מסתיר תוכן שכבר הוצג - השתמש/י ב-@if לכך
- Server-Side Rendering (SSR) מציג רק את ה-@placeholder

🎯 **מטרת התרגיל:**
התרגיל מדמה מצב אמיתי של אופטימיזציה של אפליקציית e-commerce. חנויות מקוונות, פורטלים, ואפליקציות תוכן - כולן משתמשות ב-lazy loading כדי לשפר ביצועים.

📊 **תוצאה צפויה:**
- הפחתה של 40-60% בגודל ה-bundle הראשוני
- שיפור ב-Time to Interactive (TTI)
- חווית משתמש טובה יותר עם loading states

---

**בהצלחה! 🚀⚡**

### התחלה מהירה

מוכנים להתחיל? צרו את הפרויקט:
```bash
ng new angular-defer-exercise
cd angular-defer-exercise
ng generate component product-list
ng generate component product-details
ng generate component product-reviews
ng generate component related-products
ng generate component product-analytics
ng generate component promotional-banner
```

**זכרו:** הקומפוננטות צריכות להיות standalone!
```bash
ng generate component product-details --standalone
```
